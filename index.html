<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LineART">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">

    <title>LineART</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="chart.js"></script>
    <link rel="stylesheet" href="lib/leaflet/leaflet.css">
    <script src="lib/leaflet/leaflet.js"></script>
    <link rel="stylesheet" href="map-markers.css">
    <style>
        /* Map Edit Markers - Inlined for reliability */
        .vertex-marker {
            z-index: 1000 !important;
            background: white !important;
            border: 2px solid #3b82f6 !important;
            border-radius: 50% !important;
            width: 12px !important;
            height: 12px !important;
            cursor: move !important;
            pointer-events: auto !important;
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.5);
        }

        .mid-marker {
            z-index: 999 !important;
            background: rgba(255, 255, 255, 0.8) !important;
            border: 1px solid #666 !important;
            border-radius: 50% !important;
            width: 10px !important;
            height: 10px !important;
            cursor: pointer !important;
            pointer-events: auto !important;
            transition: opacity 0.2s;
        }

        .mid-marker:hover {
            opacity: 1;
            background: white !important;
            border-color: #3b82f6 !important;
            border-radius: 50% !important;
        }
    </style>
    <script>
        // Auth Check
        if (!localStorage.getItem('authToken')) {
            window.location.replace('login.html');
        }
    </script>
</head>

<body>
    <script>
        if (window.location.protocol === 'file:') {
            document.write(`
                <div style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-family:sans-serif; text-align:center; padding:20px;">
                    <h1 style="color:#ff4444; margin-bottom:20px;">‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! ‚ö†Ô∏è</h1>
                    <p style="font-size:1.2rem; max-width:600px; line-height:1.6;">
                        –í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é –∫–∞–∫ —Ñ–∞–π–ª (–û—à–∏–±–∫–∞ CORS).<br>
                        –î–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä (node server.js) –∏ –æ—Ç–∫—Ä—ã—Ç—å http://localhost:3000
                    </p>
                    <div style="background:#333; padding:20px; border-radius:10px; margin-top:30px; border:1px solid #555;">
                        <p style="margin-bottom:10px; color:#aaa;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É:</p>
                        <h2 style="color:#4caf50; margin:0;"><a href="http://localhost:3000/login.html" style="color:#4caf50;">http://localhost:3000/login.html</a></h2>
                    </div>
                </div>
            `);
            throw new Error("Execution stopped due to file protocol");
        }
    </script>
    <div class="app-container">
        <!-- Mobile Overlay -->
        <div id="mobile-overlay" class="mobile-overlay" onclick="toggleMobileMenu()"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="logo" style="display: flex; justify-content: space-between; align-items: center;">
                <!-- Mobile Close Button -->
                <button class="mobile-close-btn" onclick="toggleMobileMenu()">‚úï</button>
                <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;"
                    onclick="switchTab('dashboard')">
                    <div class="logo-icon">L</div>
                    <span>LineART</span>
                </div>
            </div>
            <nav class="nav-menu">
                <button class="nav-item active" data-tab="dashboard">
                    <span class="icon">üìä</span> –î–∞—à–±–æ—Ä–¥
                </button>
                <button class="nav-item" data-tab="analytics">
                    <span class="icon">üìà</span> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </button>
                <button class="nav-item" data-tab="projects">
                    <span class="icon">üèóÔ∏è</span> –ü—Ä–æ–µ–∫—Ç—ã
                </button>
                <button class="nav-item" data-tab="calendar">
                    <span class="icon">üìÖ</span> –ö–∞–ª–µ–Ω–¥–∞—Ä—å
                </button>
                <button class="nav-item" onclick="openGanttModal()">
                    <span class="icon">üìä</span> Gantt
                </button>
                <button class="nav-item" data-tab="finances">
                    <span class="icon">üí∞</span> –§–∏–Ω–∞–Ω—Å—ã
                </button>
                <button class="nav-item" data-tab="clients">
                    <span class="icon">üë•</span> –ö–ª–∏–µ–Ω—Ç—ã
                </button>
                <button class="nav-item" data-tab="employees">
                    <span class="icon">üë∑‚Äç‚ôÇÔ∏è</span> –ò–Ω–∂–µ–Ω–µ—Ä—ã
                </button>
            </nav>

            <!-- Theme Toggle Removed -->

            <!-- Backup Controls -->
            <div class="backup-controls admin-only"
                style="padding: 10px 15px; border-top: 1px solid var(--glass-border);">
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px;">üíæ –†–µ–∑–µ—Ä–≤–Ω–æ–µ
                    –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-sm" onclick="exportAllProjects()" title="–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤"
                        style="flex: 1; font-size: 0.75rem;">
                        üì§ –≠–∫—Å–ø–æ—Ä—Ç
                    </button>
                    <button class="btn-sm" onclick="openImportDialog()" title="–ò–º–ø–æ—Ä—Ç –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏"
                        style="flex: 1; font-size: 0.75rem;">
                        üì• –ò–º–ø–æ—Ä—Ç
                    </button>
                </div>
            </div>

            <!-- Telegram Settings -->
            <div class="telegram-controls admin-only"
                style="padding: 10px 15px; border-top: 1px solid var(--glass-border);">
                <button class="btn-sm" onclick="openTelegramSettings()" style="width: 100%; font-size: 0.75rem;">
                    üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram
                </button>
            </div>

            <!-- Notification Settings -->
            <div style="padding: 10px 15px;">
                <button class="btn-sm" onclick="openNotificationSettings()" style="width: 100%; font-size: 0.75rem;">
                    üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞
                </button>
            </div>

            <!-- Auto Reminders -->
            <div class="admin-only" style="padding: 0 15px 10px 15px;">
                <button class="btn-sm" onclick="openAutoRemindersSettings()" style="width: 100%; font-size: 0.75rem;">
                    ‚è∞ –ê–≤—Ç–æ–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                </button>
            </div>

            <!-- Activity Log -->
            <div class="admin-only" style="padding: 0 15px 10px 15px;">
                <button class="btn-sm" onclick="openActivityLogModal()" style="width: 100%; font-size: 0.75rem;">
                    üìã –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
                </button>
            </div>

            <!-- Client Rating -->
            <div class="admin-only" style="padding: 0 15px 10px 15px;">
                <button class="btn-sm" onclick="openClientRatingModal()" style="width: 100%; font-size: 0.75rem;">
                    üèÜ –†–µ–π—Ç–∏–Ω–≥ –∫–ª–∏–µ–Ω—Ç–æ–≤
                </button>
            </div>

            <div class="user-profile">
                <div class="avatar">üë§</div>
                <div class="user-info">
                    <div class="name">–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä</div>
                    <div class="role">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</div>
                    <button class="btn-sm" onclick="openLinkTelegramModal()"
                        style="margin-top: 5px; font-size: 0.7rem; padding: 2px 5px; width: 100%;">
                        üîó Telegram
                    </button>
                </div>
                <button onclick="logout()" title="–í—ã–π—Ç–∏"
                    style="background:none; border:none; color:var(--text-secondary); cursor:pointer; margin-left:auto;">
                    üö™
                </button>
            </div>
        </aside>

        <script>
            function logout() {
                localStorage.removeItem('authToken');
                window.location.replace('login.html');
            }

            // Theme Toggle
            function toggleTheme() {
                const body = document.body;
                const isLight = body.classList.toggle('light-theme');
                localStorage.setItem('theme', isLight ? 'light' : 'dark');
                updateThemeButton(isLight);
            }

            function updateThemeButton(isLight) {
                const icon = document.getElementById('theme-icon');
                const label = document.getElementById('theme-label');
                if (icon) icon.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
                if (label) label.textContent = isLight ? '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : '–¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
            }

            // Apply saved theme on load
            (function () {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'light') {
                    document.body.classList.add('light-theme');
                    // Update button after DOM is ready
                    document.addEventListener('DOMContentLoaded', () => updateThemeButton(true));
                }
            })();
        </script>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="top-bar" style="display: flex; align-items: center; gap: 15px;">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" style="display: none;">‚ò∞</button>
                <h1 id="page-title" style="margin: 0;">–î–∞—à–±–æ—Ä–¥</h1>
            </header>

            <!-- Views -->
            <div id="dashboard-view" class="view active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</div>
                        <div class="stat-value" id="stat-active-projects">0</div>
                        <div class="stat-trend positive">–í —Ä–∞–±–æ—Ç–µ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–í—ã—Ä—É—á–∫–∞ (–º–µ—Å)</div>
                        <div class="stat-value-group">
                            <div id="stat-revenue-usd">0 $</div>
                            <div id="stat-revenue-uzs">0 —Å—É–º</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å</div>
                        <div class="stat-value-group">
                            <div id="stat-profit-usd">0 $</div>
                            <div id="stat-profit-uzs">0 —Å—É–º</div>
                        </div>
                    </div>
                </div>

                <div class="charts-section">
                    <div class="chart-card full-width" style="height: auto;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3>üìä –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –¥–∏–Ω–∞–º–∏–∫–∞</h3>
                            <select id="chart-period" onchange="updateDashboardChart()"
                                style="padding: 6px 12px; border-radius: 8px; background: rgba(255,255,255,0.1); border: 1px solid var(--glass-border); color: var(--text-primary); font-size: 0.85rem;">
                                <option value="1">–ü–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü</option>
                                <option value="3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
                                <option value="6" selected>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤</option>
                                <option value="12">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 12 –º–µ—Å—è—Ü–µ–≤</option>
                            </select>
                        </div>
                        <div style="height: 350px; position: relative;">
                            <canvas id="dashboard-finance-chart"></canvas>
                        </div>
                        <div id="chart-legend"
                            style="display: flex; justify-content: center; gap: 25px; margin-top: 15px; font-size: 0.85rem;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div
                                    style="width: 12px; height: 12px; background: linear-gradient(135deg, #10b981, #34d399); border-radius: 3px;">
                                </div>
                                <span>–î–æ—Ö–æ–¥—ã</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div
                                    style="width: 12px; height: 12px; background: linear-gradient(135deg, #ef4444, #f87171); border-radius: 3px;">
                                </div>
                                <span>–†–∞—Å—Ö–æ–¥—ã</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <div
                                    style="width: 12px; height: 12px; background: linear-gradient(135deg, #6366f1, #818cf8); border-radius: 3px;">
                                </div>
                                <span>–ü—Ä–∏–±—ã–ª—å</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recent-section">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç—ã</h3>
                    <div id="dashboard-projects-grid" class="compact-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Dashboard Map -->
                <!-- Dashboard Map -->
                <div class="chart-card full-width" style="margin-top: 20px; height: auto;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>–ö–∞—Ä—Ç–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
                        <!-- Filters removed by user request -->
                    </div>
                    <div id="dashboard-map-wrapper"
                        style="position: relative; border-radius: 12px; overflow: hidden; width: 100%; height: 600px;">
                        <div id="dashboard-map" style="width: 100%; height: 100%; z-index: 1; border-radius: 12px;">
                        </div>
                        <button id="dashboard-map-fullscreen-btn" class="btn-secondary"
                            onclick="toggleDashboardMapFullscreen()" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω"
                            style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(30,30,30,0.8); backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.1); width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer;">
                            ‚õ∂
                        </button>
                    </div>
                </div>
            </div>

            <div id="analytics-view" class="view">
                <!-- Populated by JS -->
            </div>

            <div id="calendar-view" class="view">
                <div id="calendar-container">
                    <!-- Populated by renderCalendar() -->
                </div>
            </div>

            <div id="projects-view" class="view">
                <div class="toolbar">
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞..." class="search-input" id="project-search">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <!-- Sort Dropdown -->
                        <select id="project-sort" class="search-input" style="width: auto;"
                            onchange="window.renderProjects()">
                            <option value="date-desc">üìÖ –°–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ</option>
                            <option value="date-asc">üìÖ –°–Ω–∞—á–∞–ª–∞ —Å—Ç–∞—Ä—ã–µ</option>
                            <option value="progress-desc">üìä –ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É ‚Üì</option>
                            <option value="progress-asc">üìä –ü–æ –ø—Ä–æ–≥—Ä–µ—Å—Å—É ‚Üë</option>
                            <option value="status">üè∑Ô∏è –ü–æ —Å—Ç–∞—Ç—É—Å—É</option>
                            <option value="name">üî§ –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
                        </select>
                        <select id="project-filter-status" class="search-input" style="width: auto;">
                            <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                            <option value="on-review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</option>
                            <option value="correction">–ù–∞ –ø—Ä–∞–≤–∫—É</option>
                            <option value="accepted">–ü—Ä–∏–Ω—è—Ç–æ</option>
                        </select>
                        <button class="btn-primary admin-only" onclick="openNewProjectModal()">+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</button>
                    </div>
                </div>

                <div class="projects-grid" id="projects-grid">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div id="finances-view" class="view">
                <div class="finance-layout">
                    <div class="transactions-panel">
                        <div class="panel-header">
                            <h3>–û–ø–µ—Ä–∞—Ü–∏–∏</h3>
                            <button class="btn-sm" onclick="openModal('transaction-modal')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                        <ul class="transaction-list" id="transaction-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                    <div class="finance-summary">
                        <div class="summary-card income">
                            <span>–î–æ—Ö–æ–¥—ã</span>
                            <div class="multi-currency-total">
                                <h2 id="total-income-usd">0 $</h2>
                                <h2 id="total-income-uzs">0 —Å—É–º</h2>
                            </div>
                        </div>
                        <div class="summary-card expense">
                            <span>–†–∞—Å—Ö–æ–¥—ã</span>
                            <div class="multi-currency-total">
                                <h2 id="total-expense-usd">0 $</h2>
                                <h2 id="total-expense-uzs">0 —Å—É–º</h2>
                            </div>
                        </div>
                        <div class="summary-card profit">
                            <span>–ò—Ç–æ–≥–æ</span>
                            <div class="multi-currency-total">
                                <h2 id="total-net-usd">0 $</h2>
                                <h2 id="total-net-uzs">0 —Å—É–º</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clients-view" class="view">
                <div class="toolbar">
                    <button class="btn-primary" onclick="openModal('client-modal')">+ –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</button>
                </div>
                <div class="compact-grid" id="clients-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div id="client-details-view" class="view">
                <div class="details-header">
                    <button class="btn-secondary" onclick="closeClientDetailsPage()">‚Üê –ù–∞–∑–∞–¥</button>
                    <div class="actions">
                        <button class="btn-secondary" id="client-page-edit-btn">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-danger admin-only" id="client-page-delete-btn">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>

                <div class="details-grid-2col" style="margin-bottom: 30px;">
                    <!-- Client Info -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3 style="font-size: 1.1rem; color: var(--text-secondary); text-transform: uppercase;">
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h3>
                        </div>
                        <h1 id="client-page-name" style="font-size: 2.2rem; margin-bottom: 25px;">-</h1>

                        <div class="client-details" style="font-size: 1.1rem;">
                            <div class="detail-row"
                                style="padding: 12px 0; border-bottom: 1px solid var(--glass-border);">
                                <span class="label" style="display: flex; align-items: center; gap: 10px;"><span
                                        class="icon">üìû</span> –¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                <span class="value" id="client-page-phone">-</span>
                            </div>
                            <div class="detail-row" style="padding: 12px 0;">
                                <span class="label" style="display: flex; align-items: center; gap: 10px;"><span
                                        class="icon">‚úàÔ∏è</span> Telegram:</span>
                                <a href="#" target="_blank" class="value link" id="client-page-telegram">-</a>
                            </div>
                        </div>
                    </div>

                    <!-- Client Stats -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3 style="font-size: 1.1rem; color: var(--text-secondary); text-transform: uppercase;">
                                –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">–í—Å–µ–≥–æ
                                    –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
                                <div id="client-page-total-projects" style="font-size: 1.8rem; font-weight: 600;">0
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">
                                    –ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                                <div id="client-page-active-projects"
                                    style="font-size: 1.8rem; font-weight: 600; color: var(--accent-primary);">0</div>
                            </div>
                        </div>

                        <div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">–û–±—â–∞—è
                                –≤—ã—Ä—É—á–∫–∞</div>
                            <div class="stat-value-group">
                                <div id="client-page-revenue-usd"
                                    style="font-size: 2rem; color: var(--accent-success); font-weight: 600;">0 $</div>
                                <div id="client-page-revenue-uzs"
                                    style="font-size: 1.2rem; color: var(--text-secondary);">0 —Å—É–º</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recent-section">
                    <h3 style="margin-bottom: 20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤</h3>
                    <div id="client-projects-list" class="compact-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div id="employees-view" class="view">
                <div class="toolbar">
                    <button class="btn-primary" onclick="openNewEmployeeModal()">+ –ù–æ–≤—ã–π –∏–Ω–∂–µ–Ω–µ—Ä</button>
                </div>
                <div class="compact-grid" id="employees-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div id="engineer-details-view" class="view">
                <div class="details-header">
                    <button class="btn-secondary" onclick="closeEngineerDetailsPage()">‚Üê –ù–∞–∑–∞–¥</button>
                    <div class="actions">
                        <button class="btn-secondary" id="engineer-page-edit-btn">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-danger admin-only" id="engineer-page-delete-btn">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>

                <div class="details-grid-2col" style="margin-bottom: 30px;">
                    <!-- Engineer Info -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3 style="font-size: 1.1rem; color: var(--text-secondary); text-transform: uppercase;">
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω–∂–µ–Ω–µ—Ä–µ</h3>
                        </div>
                        <h1 id="engineer-page-name" style="font-size: 2.2rem; margin-bottom: 25px;">-</h1>

                        <div class="client-details" style="font-size: 1.1rem;">
                            <div class="detail-row"
                                style="padding: 12px 0; border-bottom: 1px solid var(--glass-border);">
                                <span class="label" style="display: flex; align-items: center; gap: 10px;"><span
                                        class="icon">üë∑‚Äç‚ôÇÔ∏è</span> –î–æ–ª–∂–Ω–æ—Å—Ç—å:</span>
                                <span class="value" id="engineer-page-position">-</span>
                            </div>
                            <div class="detail-row" style="padding: 12px 0;">
                                <span class="label" style="display: flex; align-items: center; gap: 10px;"><span
                                        class="icon">üìû</span> –¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                <span class="value" id="engineer-page-phone">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Engineer Stats -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3 style="font-size: 1.1rem; color: var(--text-secondary); text-transform: uppercase;">
                                –§–∏–Ω–∞–Ω—Å—ã</h3>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px;">
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">
                                    –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
                                <div id="engineer-page-total-projects" style="font-size: 1.8rem; font-weight: 600;">0
                                </div>
                                <div id="engineer-page-status-list"
                                    style="margin-top: 10px; font-size: 0.85rem; color: var(--text-secondary); display: flex; flex-direction: column; gap: 4px;">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">
                                    –ë–∞–ª–∞–Ω—Å (–í—ã–ø–ª–∞—á–µ–Ω–æ)</div>
                                <div class="stat-value-group">
                                    <div id="engineer-page-paid-usd"
                                        style="font-size: 1.4rem; color: var(--accent-success); font-weight: 600;">0 $
                                    </div>
                                    <div id="engineer-page-paid-uzs"
                                        style="font-size: 1rem; color: var(--text-secondary);">0 —Å—É–º</div>
                                </div>
                            </div>
                        </div>

                        <div class="finance-breakdown"
                            style="padding-top: 15px; border-top: 1px solid var(--glass-border);">
                            <div class="finance-row">
                                <span>–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (USD)</span>
                                <span id="engineer-page-contract-usd">0 $</span>
                            </div>
                            <div class="finance-row">
                                <span>–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (UZS)</span>
                                <span id="engineer-page-contract-uzs">0 —Å—É–º</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recent-section">
                    <h3 style="margin-bottom: 20px;">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç—ã –∏ –≤—ã–ø–ª–∞—Ç</h3>
                    <div id="engineer-projects-list" class="compact-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>


            <div id="project-details-view" class="view">
                <div class="details-header">
                    <button class="btn-secondary" onclick="closeProjectDetails()">‚Üê –ù–∞–∑–∞–¥</button>
                    <div class="actions">
                        <button class="btn-secondary admin-only" onclick="openDocumentMenu(currentProjectId)"
                            title="–î–æ–∫—É–º–µ–Ω—Ç—ã">üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã</button>
                        <button class="btn-secondary" onclick="showProjectQRCode(currentProjectId)" title="QR-–∫–æ–¥">üì±
                            QR</button>
                        <button class="btn-secondary" onclick="generateProjectPDF(window.currentProjectId)"
                            title="–≠–∫—Å–ø–æ—Ä—Ç –≤ PDF">üìë PDF</button>
                        <button class="btn-secondary admin-only"
                            onclick="archiveProject(window.currentProjectId, document.getElementById('detail-project-name').innerText)"
                            title="–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å">üì¶ –ê—Ä—Ö–∏–≤</button>
                        <button class="btn-secondary admin-only" onclick="openAutoAssignModal(window.currentProjectId)"
                            title="–ê–≤—Ç–æ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ">ü§ñ –ê–≤—Ç–æ</button>
                        <button class="btn-secondary" onclick="openHistoryModal()">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                        <button class="btn-secondary" onclick="editCurrentProject()">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn-danger admin-only" onclick="deleteCurrentProject()">üóë –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>

                <div class="details-card"
                    style="margin-bottom: 30px; padding: 30px; background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 16px;">
                    <div style="display: flex;">
                        <!-- Left Side: Project Info -->
                        <div style="flex: 1;">
                            <div class="card-header" style="margin-bottom: 25px;">
                                <h3
                                    style="font-size: 1.1rem; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">
                                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ</h3>
                                <button class="btn-edit-icon" onclick="editCurrentProject()" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7">
                                        </path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z">
                                        </path>
                                    </svg>
                                </button>
                            </div>

                            <div id="detail-correction-alert"
                                style="display: none; background: rgba(255, 68, 68, 0.1); border: 1px solid #ff4444; color: #ff8888; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            </div>
                            <h1 id="detail-project-name" style="font-size: 2rem; margin-bottom: 10px;">-</h1>
                            <div id="detail-project-address"
                                style="color: var(--text-secondary); margin-bottom: 20px; font-size: 1.1rem;">-
                            </div>
                            <div id="detail-project-description"
                                style="margin-bottom: 20px; color: var(--text-primary); white-space: pre-wrap; display: none; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; border-left: 3px solid var(--accent-primary);">
                            </div>

                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.03);">
                                <span class="label"
                                    style="color: var(--text-secondary); display: flex; align-items: center; gap: 8px;"><span>üîπ</span>
                                    –°—Ç–∞—Ç—É—Å</span>
                                <span id="detail-project-status" class="status-badge"
                                    style="font-size: 0.9rem; padding: 6px 12px;">–°—Ç–∞—Ç—É—Å</span>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                <span class="label"
                                    style="color: var(--text-secondary); display: flex; align-items: center; gap: 8px;"><span>üìÖ</span>
                                    –°–æ–∑–¥–∞–Ω</span>
                                <span id="detail-project-created" class="value"
                                    style="font-family: monospace; font-size: 1rem;">-</span>
                            </div>
                        </div>

                        <!-- Vertical Divider -->
                        <div class="admin-only" style="width: 1px; background: rgba(255,255,255,0.2); margin: 0 30px;">
                        </div>

                        <!-- Right Side: Contacts -->
                        <div class="admin-only" style="flex: 1;">
                            <div class="card-header" style="margin-bottom: 25px;">
                                <h3
                                    style="font-size: 1.1rem; color: var(--text-secondary); font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">
                                    –ö–æ–Ω—Ç–∞–∫—Ç—ã</h3>
                                <button class="btn-action-sm" onclick="openAdditionalPersonModal()">+
                                    –î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                            <div class="contacts-content">
                                <div class="contact-group"
                                    style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                                    <div class="label"
                                        style="margin-bottom: 8px; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase;">
                                        –ö–ª–∏–µ–Ω—Ç</div>
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div
                                            style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2rem;">
                                            üë§</div>
                                        <div id="detail-project-client" class="value"
                                            style="font-weight: 600; font-size: 1.1rem;">-
                                        </div>
                                    </div>
                                </div>

                                <div style="padding-top: 10px;">
                                    <div class="label"
                                        style="margin-bottom: 15px; color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase;">
                                        –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã</div>
                                    <div id="detail-additional-persons-list" class="compact-grid"
                                        style="grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <!-- Populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="details-grid-2col">
                    <!-- Finance Card -->
                    <div class="details-card admin-only">
                        <div class="card-header">
                            <h3>–§–∏–Ω–∞–Ω—Å—ã</h3>
                            <button class="btn-icon-sm" onclick="editCurrentProject()">‚úé</button>
                        </div>
                        <div class="finance-breakdown">
                            <div class="finance-row">
                                <span>–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞</span>
                                <span id="detail-finance-total">0</span>
                            </div>
                            <div class="finance-row">
                                <span>–û–ø–ª–∞—á–µ–Ω–æ</span>
                                <span id="detail-finance-paid">0</span>
                            </div>
                            <div class="finance-row">
                                <span>–†–∞—Å—Ö–æ–¥—ã</span>
                                <span id="detail-finance-expenses">0</span>
                            </div>
                            <div class="finance-row">
                                <span>–ü—Ä–∏–±—ã–ª—å</span>
                                <span id="detail-finance-profit">0</span>
                            </div>
                            <div class="finance-divider"></div>
                            <div class="finance-row total">
                                <span>–û—Å—Ç–∞—Ç–æ–∫</span>
                                <span id="detail-finance-balance">0</span>
                            </div>

                            <div class="progress-container" style="margin-top: 15px;">
                                <div class="progress-bar"
                                    style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                    <div id="detail-finance-bar"
                                        style="width: 0%; height: 100%; background: var(--accent-success); transition: width 0.3s;">
                                    </div>
                                </div>
                                <div
                                    style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 0.8rem; color: var(--text-secondary);">
                                    <span>–ü—Ä–æ—Ü–µ–Ω—Ç –æ–ø–ª–∞—Ç—ã</span>
                                    <span id="detail-finance-percent">0%</span>
                                </div>
                            </div>

                            <div style="height: 200px; margin-top: 20px;">
                                <canvas id="financeChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Comments Card -->
                    <div class="details-card">
                        <div class="card-header">
                            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="new-comment-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."
                                class="search-input" style="margin-bottom: 0;">
                            <button class="btn-primary" onclick="addProjectComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                        </div>
                        <div id="project-comments-list" class="comments-list"
                            style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                            <!-- Populated by JS -->
                            <div style="text-align: center; color: var(--text-secondary); padding: 20px;">–ù–µ—Ç
                                –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</div>
                        </div>
                    </div>

                    <!-- Transactions Card -->
                    <div class="details-card admin-only">
                        <div class="card-header">
                            <h3>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
                            <button class="btn-action-sm" onclick="openTransactionModalForProject()">+
                                –û–ø–µ—Ä–∞—Ü–∏—è</button>
                        </div>
                        <div class="transactions-list-container" style="max-height: 400px; overflow-y: auto;">
                            <ul id="detail-transaction-list" class="transaction-list">
                                <!-- Populated by JS -->
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Sections -->
                <div class="details-card" style="margin-top: 20px;">
                    <div class="section-header"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>–†–∞–∑–¥–µ–ª—ã –ø—Ä–æ–µ–∫—Ç–∞</h3>
                        <button class="btn-action-sm admin-only" onclick="openNewSectionModal()">+ –ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</button>
                    </div>
                    <div id="detail-sections-list">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Gallery -->
                <div class="details-card" style="margin-top: 20px;">
                    <div class="section-header"
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>–ì–∞–ª–µ—Ä–µ—è</h3>
                        <label class="btn-action-sm admin-only" style="cursor: pointer;">
                            + –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                            <input type="file" multiple accept="image/*" style="display: none;"
                                onchange="handleGalleryFileUpload(this)">
                        </label>
                    </div>
                    <div id="detail-gallery-grid" class="gallery-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Location Map -->
                <div class="details-card" style="margin-top: 20px;">
                    <div class="section-header" style="margin-bottom: 15px;">
                        <h3>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</h3>
                    </div>
                    <div id="map-wrapper" style="position: relative; border-radius: 12px; overflow: hidden;">
                        <div id="project-map" style="height: 800px; width: 100%; z-index: 1;"></div>

                        <!-- Unified Map UI Container -->
                        <div id="map-ui-container" class="map-ui-overlay">

                            <!-- Search Bar Removed -->

                            <!-- Bottom Right: Fixed Tools (Fullscreen) -->
                            <div class="map-tools-bottom-right">
                                <button id="btn-toggle-fullscreen" class="btn-glass icon-only"
                                    onclick="toggleProjectMapFullscreen()" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">
                                    ‚õ∂
                                </button>
                            </div>

                            <!-- Bottom Center: Action Dock -->
                            <div class="map-dock-wrapper">
                                <!-- View Mode Toolbar -->
                                <div id="map-view-dock" class="map-dock glass-panel">
                                    <button class="btn-dock primary" onclick="MapManager.startEdit()">
                                        ‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É
                                    </button>
                                </div>

                                <!-- Edit Mode Toolbar -->
                                <div id="map-edit-dock" class="map-dock glass-panel" style="display: none;">
                                    <button id="btn-add-marker" class="btn-dock icon-btn"
                                        onclick="MapManager.setMode('marker')" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∫—É">
                                        üìç <span class="btn-label">–ú–µ—Ç–∫–∞</span>
                                    </button>
                                    <button id="btn-draw-contour" class="btn-dock icon-btn"
                                        onclick="MapManager.setMode('contour')" title="–†–∏—Å–æ–≤–∞—Ç—å –∫–æ–Ω—Ç—É—Ä">
                                        ‚¨† <span class="btn-label">–ö–æ–Ω—Ç—É—Ä</span>
                                    </button>

                                    <div class="dock-divider"></div>

                                    <button id="btn-clear-map" class="btn-dock icon-btn" onclick="MapManager.clear()"
                                        title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ">
                                        üóë
                                    </button>

                                    <div class="dock-divider"></div>

                                    <button class="btn-dock success" onclick="MapManager.save()">
                                        ‚úì –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                    </button>
                                    <button class="btn-dock danger" onclick="MapManager.cancelEdit()">
                                        ‚úñ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals moved to end of body for correct layering -->

    <!-- Day Details Modal (Calendar) -->
    <div id="day-details-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <!-- Populated by showDayDetails() -->
        </div>
    </div>

    <div id="status-change-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeModal('status-change-modal')">&times;</span>
            <h2>–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</h2>
            <div class="status-options" style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <div id="project-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('project-modal')">&times;</span>
            <h2>–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h2>
            <form id="project-form">
                <input type="hidden" name="id">
                <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" required>
                <input type="text" name="address" placeholder="–ê–¥—Ä–µ—Å (–º–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ)">

                <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"
                    style="width: 100%; height: 100px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: white; padding: 10px; margin-bottom: 15px; resize: vertical; font-family: inherit;"></textarea>

                <div class="input-group">
                    <select name="client" required>
                        <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞</option>
                    </select>
                    <button type="button" class="btn-icon" onclick="openModal('client-modal')"
                        title="–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞">+</button>
                </div>

                <div class="input-group">
                    <input type="number" name="amount" placeholder="–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞" required>
                    <select name="currency">
                        <option value="USD">USD ($)</option>
                        <option value="UZS">UZS (—Å—É–º)</option>
                    </select>
                </div>

                <select name="status">
                    <option value="sketch">–≠—Å–∫–∏–∑</option>
                    <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                    <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                    <option value="delivered">–°–¥–∞–Ω</option>
                </select>

                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="history-modal" class="modal">
        <div class="modal-content" style="width: 500px; max-height: 80vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('history-modal')">&times;</span>
            <h2>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
            <div id="project-history-list" class="history-list">
                <!-- History items -->
            </div>
        </div>
    </div>

    <div id="engineer-stats-modal" class="modal">
        <div class="modal-content" style="width: 500px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('engineer-stats-modal')">&times;</span>
            <h2 id="stats-engineer-name">–ò–Ω–∂–µ–Ω–µ—Ä</h2>
            <div style="margin-bottom: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                <div id="stats-engineer-position"></div>
                <div id="stats-engineer-phone"></div>
            </div>

            <div class="contract-display-container">
                <div id="contract-view-mode" class="contract-view">
                    <div style="display: flex; align-items: center;">
                        <span class="currency-symbol">$</span>
                        <span id="contract-display-value" class="contract-value">0</span>
                    </div>
                    <button class="btn-icon-sm" onclick="toggleContractEdit()">‚úé</button>
                </div>
                <div id="contract-edit-mode" class="contract-edit" style="display: none;">
                    <input type="number" id="engineer-contract-amount" placeholder="–°—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞"
                        style="width: 120px;">
                    <button class="btn-icon-sm success" onclick="saveContractEdit()">‚úì</button>
                </div>
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                    –°—É–º–º–∞
                    –¥–æ–≥–æ–≤–æ—Ä–∞
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="label">–í—ã–ø–ª–∞—á–µ–Ω–æ</div>
                    <div class="value" id="stats-engineer-revenue">0</div>
                </div>
                <div class="stat-card">
                    <div class="label">–û—Å—Ç–∞—Ç–æ–∫</div>
                    <div class="value" style="color: var(--text-secondary);">calc</div>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>–°–¥–µ–ª–∞—Ç—å –≤—ã–ø–ª–∞—Ç—É</h3>
                <div class="input-group">
                    <input type="number" id="engineer-payment-amount" placeholder="–°—É–º–º–∞">
                    <button class="btn-primary" onclick="addEngineerPayment()">–í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <h3>–†–∞–∑–¥–µ–ª—ã</h3>
                <div id="stats-engineer-sections" class="compact-list">
                    <!-- Sections -->
                </div>
            </div>

            <div>
                <h3>–ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–ª–∞—Ç</h3>
                <div id="stats-engineer-transactions" class="compact-list">
                    <!-- Transactions -->
                </div>
            </div>
        </div>
    </div>

    <div id="additional-person-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('additional-person-modal')">&times;</span>
            <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h2>
            <form id="additional-person-form">
                <input type="text" name="name" placeholder="–ò–º—è" required>
                <input type="text" name="position" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
                <input type="tel" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="client-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('client-modal')">&times;</span>
            <h2>–ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç</h2>
            <form id="client-form">
                <input type="hidden" name="id">
                <input type="text" name="name" placeholder="–ò–º—è" required>
                <input type="tel" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
                <input type="text" name="telegram" placeholder="Telegram (@username)">
                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="client-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('client-details-modal')">&times;</span>
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–ª–∏–µ–Ω—Ç–µ</h2>
            <div class="client-details">
                <div class="detail-row">
                    <span class="label">–ò–º—è:</span>
                    <span class="value" id="client-detail-name">-</span>
                </div>
                <div class="detail-row">
                    <span class="label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                    <span class="value" id="client-detail-phone">-</span>
                </div>
                <div class="detail-row">
                    <span class="label">Telegram:</span>
                    <a href="#" target="_blank" class="value link" id="client-detail-telegram">-</a>
                </div>

                <div id="client-stats-container"
                    style="margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                    <div class="detail-row">
                        <span class="label">–ü—Ä–æ–µ–∫—Ç–æ–≤:</span>
                        <span class="value" id="client-detail-projects-count">0</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:</span>
                        <span class="value" id="client-detail-total-revenue">0 $</span>
                    </div>
                </div>

                <div class="modal-actions"
                    style="margin-top: 20px; text-align: right; display: flex; justify-content: flex-end; gap: 10px;">
                    <button id="client-edit-btn" class="btn-secondary">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button id="client-delete-btn" class="btn-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <div id="project-expense-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('project-expense-modal')">&times;</span>
            <h2>–ù–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥</h2>
            <form id="project-expense-form">
                <input type="hidden" id="expense-project-id">
                <select name="engineer" id="expense-engineer">
                    <option value="">–ë–µ–∑ –∏–Ω–∂–µ–Ω–µ—Ä–∞ (–æ–±—â–∏–π —Ä–∞—Å—Ö–æ–¥)</option>
                </select>
                <input type="text" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" required>
                <div class="input-group">
                    <input type="number" name="amount" placeholder="–°—É–º–º–∞" required>
                    <select name="currency">
                        <option value="USD">USD ($)</option>
                        <option value="UZS">UZS (—Å—É–º)</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('transaction-modal')">&times;</span>
            <h2>–ù–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è</h2>
            <form id="transaction-form">
                <input type="hidden" name="projectId">
                <select name="type">
                    <option value="income">–î–æ—Ö–æ–¥</option>
                    <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                </select>
                <input type="text" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" required>
                <div class="input-group">
                    <input type="number" name="amount" placeholder="–°—É–º–º–∞" required>
                    <select name="currency">
                        <option value="USD">USD ($)</option>
                        <option value="UZS">UZS (—Å—É–º)</option>
                    </select>
                </div>
                <input type="date" name="date" required>
                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="section-modal" class="modal">
        <div class="modal-content" style="max-width: 380px;">
            <span class="close" onclick="closeModal('section-modal')">&times;</span>
            <h2>–ù–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª</h2>
            <form id="section-form">
                <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞" required>
                <select name="engineer" id="section-engineer-select">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–∂–µ–Ω–µ—Ä–∞</option>
                </select>
                <select name="status">
                    <option value="in-progress">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</option>
                    <option value="on-review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫—É</option>
                    <option value="correction">–ù–∞ –ø—Ä–∞–≤–∫—É</option>
                    <option value="accepted">–ü—Ä–∏–Ω—è—Ç–æ</option>
                </select>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <label
                            style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 5px;">–î–∞—Ç–∞
                            –Ω–∞—á–∞–ª–∞</label>
                        <input type="date" name="startDate" style="width: 100%; box-sizing: border-box;">
                    </div>
                    <div>
                        <label
                            style="font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 5px;">–î–µ–¥–ª–∞–π–Ω</label>
                        <input type="date" name="dueDate" style="width: 100%; box-sizing: border-box;">
                    </div>
                </div>

                <button type="submit" class="btn-primary" style="margin-top: 15px;">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="file-comment-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <span class="close" onclick="closeModal('file-comment-modal')">&times;</span>
            <h2>–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</h2>
            <form id="file-comment-form">
                <input type="hidden" id="file-comment-section-id">
                <div
                    style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">–§–∞–π–ª:</div>
                    <div id="file-comment-filename" style="font-weight: 500; word-break: break-all;"></div>
                </div>
                <textarea name="comment" id="file-comment-text" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ–∞–π–ª—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                    style="width: 100%; height: 80px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 8px; color: white; padding: 10px; margin-bottom: 15px; resize: vertical; font-family: inherit;"></textarea>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('file-comment-modal')"
                        style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('employee-modal')">&times;</span>
            <h2>–ò–Ω–∂–µ–Ω–µ—Ä</h2>
            <form id="employee-form">
                <input type="hidden" name="id">
                <input type="text" name="name" placeholder="–ò–º—è" required>
                <input type="text" name="position" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å" required>
                <input type="tel" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">

                <div class="login-setup"
                    style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--glass-border);">
                    <h3
                        style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600;">
                        –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
                    <input type="text" name="username" placeholder="–õ–æ–≥–∏–Ω (–¥–ª—è –≤—Ö–æ–¥–∞)" autocomplete="off"
                        style="margin-bottom: 10px;">
                    <input type="password" name="password" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="new-password">
                </div>

                <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="lightbox-modal" class="modal lightbox">
        <span class="close" onclick="closeModal('lightbox-modal')">&times;</span>
        <img class="lightbox-content" id="lightbox-image">
        <div id="lightbox-caption"></div>
        <button class="nav-btn prev" onclick="navigateLightbox(-1)">&#10094;</button>
        <button class="nav-btn next" onclick="navigateLightbox(1)">&#10095;</button>
    </div>

    <!-- File Preview Modal -->
    <div id="file-preview-modal" class="file-preview-overlay" onclick="closeFilePreview(event)">
        <span class="file-preview-close" onclick="closeFilePreview()">&times;</span>
        <div class="file-preview-content" onclick="event.stopPropagation()">
            <img id="file-preview-image" style="display: none;">
            <iframe id="file-preview-pdf" style="display: none;"></iframe>
        </div>
    </div>

    <script>
        // File Preview Functions
        function previewFile(fileUrl, fileName) {
            const modal = document.getElementById('file-preview-modal');
            const imgEl = document.getElementById('file-preview-image');
            const pdfEl = document.getElementById('file-preview-pdf');

            // Reset
            imgEl.style.display = 'none';
            pdfEl.style.display = 'none';

            const ext = fileName.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];

            if (imageExts.includes(ext)) {
                imgEl.src = fileUrl;
                imgEl.style.display = 'block';
                modal.classList.add('active');
            } else if (ext === 'pdf') {
                pdfEl.src = fileUrl;
                pdfEl.style.display = 'block';
                modal.classList.add('active');
            } else {
                // For other files, just download
                window.open(fileUrl, '_blank');
            }
        }

        function closeFilePreview(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.getElementById('file-preview-modal');
            modal.classList.remove('active');
            document.getElementById('file-preview-image').src = '';
            document.getElementById('file-preview-pdf').src = '';
        }

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFilePreview();
            }
        });

        window.previewFile = previewFile;
        window.closeFilePreview = closeFilePreview;
    </script>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal" style="z-index: 10000;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h2 id="confirm-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</h2>
            <p id="confirm-message" style="margin: 20px 0; color: var(--text-secondary);"></p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="confirm-cancel-btn" class="btn-secondary" onclick="cancelConfirm()">–û—Ç–º–µ–Ω–∞</button>
                <button id="confirm-ok-btn" class="btn-danger" onclick="confirmAction()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // Custom confirm modal
        let confirmCallback = null;

        window.showConfirmModal = function (title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = onConfirm;
            document.getElementById('confirm-modal').style.display = 'flex';
        };

        window.confirmAction = function () {
            document.getElementById('confirm-modal').style.display = 'none';
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        };

        window.cancelConfirm = function () {
            document.getElementById('confirm-modal').style.display = 'none';
            confirmCallback = null;
        };
    </script>

    <!-- Link Telegram Modal -->
    <div id="link-telegram-modal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>üîó –ü—Ä–∏–≤—è–∑–∫–∞ Telegram</h3>
                <span class="close-btn" onclick="closeModal('link-telegram-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <p>1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ <a href="https://t.me/lineartprojectbot" target="_blank">@LineART_ProjectBot</a></p>
                <p>2. –ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É <code>/start</code></p>
                <p>3. –í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–¥ –Ω–∏–∂–µ:</p>
                <input type="text" id="telegram-link-code" placeholder="–ö–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 12345)" class="form-input"
                    style="text-align: center; font-size: 1.5rem; letter-spacing: 5px;">
                <div class="form-actions">
                    <button class="btn-primary" onclick="submitTelegramCode()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('‚úÖ Service Worker registered:', reg.scope))
                    .catch(err => console.error('‚ùå SW registration failed:', err));
            });
        }
    </script>

    <!-- Telegram Settings Modal -->
    <div id="telegram-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('telegram-settings-modal')">&times;</span>
            <h2 style="margin-bottom: 20px;">üì± –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram</h2>

            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="tg-enabled" style="width: 18px; height: 18px;">
                    <span>–í–∫–ª—é—á–∏—Ç—å Telegram-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                </label>
            </div>

            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="font-size: 1rem; color: var(--text-secondary);">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏ (—á–∞—Ç—ã/–≥—Ä—É–ø–ø—ã)</h3>
                    <button class="btn-sm" onclick="refreshTelegramChats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div id="tg-chats-list" style="max-height: 150px; overflow-y: auto;">
                    <div style="color: var(--text-secondary); padding: 15px; text-align: center;">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </div>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px;">
                    üí° –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É –∏ –Ω–∞–ø–∏—à–∏—Ç–µ /start, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å"
                </p>
            </div>

            <div style="margin-bottom: 20px;">
                <h3 style="font-size: 1rem; color: var(--text-secondary); margin-bottom: 10px;">–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h3>
                <div style="display: grid; gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="tg-status-change" checked>
                        <span>üìã –°–º–µ–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–µ–∫—Ç–∞</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="tg-new-file" checked>
                        <span>üìÅ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="tg-new-comment" checked>
                        <span>üí¨ –ù–æ–≤—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="tg-deadline" checked>
                        <span>‚è∞ –î–µ–¥–ª–∞–π–Ω—ã</span>
                    </label>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-primary" onclick="saveTelegramSettings()" style="flex: 1;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn-secondary" onclick="sendTestNotification()">üîî –¢–µ—Å—Ç</button>
            </div>
        </div>
    </div>

    <!-- Notification Settings Modal -->
    <div id="notification-settings-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <!-- Populated by openNotificationSettings() -->
        </div>
    </div>

    <script type="module" src="js/pdfExport.js"></script>
    <script type="module" src="js/ganttChart.js"></script>
    <script type="module" src="js/autoAssign.js"></script>
    <script type="module" src="js/activityLog.js"></script>
    <script type="module" src="js/clientAnalytics.js"></script>
    <script type="module" src="js/themeManager.js"></script>

    <script type="module">
        import { initNotifications } from './js/notifications.js';
        // Initialize notifications after DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => initNotifications(), 2000);
        });
    </script>
</body>

</html>